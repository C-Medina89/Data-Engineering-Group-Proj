name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      ingestion: ${{ steps.filter.outputs.ingestion }}
      transformation: ${{ steps.filter.outputs.transformation }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ingestion:
              - 'src/ingestion/**'
              - 'test/ingestion_tests/**'
            transformation:
              - 'src/transformation/**'
              - 'test/transform_test/**'

  test-ingestion:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ingestion == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pytest (ingestion)
        run: pytest -q test/ingestion_tests

  test-transformation:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.transformation == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pytest (transformation)
        run: pytest -q tests/transform_test

  lint-and-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install formatting/lint/security tools
        run: pip install black flake8 bandit pip-audit

      - name: Run Black (check only)
        run: |
          black src/ingestion/ --check
          black --check .

      - name: Lint with flake8
        run: flake8 src/ --max-line-length=120

      - name: Security - bandit (non-blocking)
        run: bandit -r src || echo "Bandit completed (issues found but not blocking)"

      - name: Security - pip-audit (non-blocking)
        run: pip-audit || echo "pip-audit completed (vulnerabilities found but not blocking)"
